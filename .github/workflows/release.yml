# 构建发布平台适配文件
# 流程：push tag → 创建 draft release → 各 job 并行构建上传 → 最后自动发布
name: release-ctool-adapter
on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

jobs:
    # 先创建 draft release，后续 job 往这个 release 上传 assets
    create-release:
        runs-on: ubuntu-latest
        outputs:
            release_id: ${{ steps.create.outputs.id }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Create Draft Release
              id: create
              uses: softprops/action-gh-release@v2
              with:
                  draft: true
                  generate_release_notes: true

    # 构建浏览器扩展 + Web
    browser-extensions:
        needs: create-release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - uses: pnpm/action-setup@v4
              name: Install pnpm
              with:
                  version: 10
                  run_install: false

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ~/.local/share/pnpm/store
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install

            - name: Build core
              run: pnpm run build
              env:
                  NODE_OPTIONS: "--max_old_space_size=4096"

            - name: Release browser extensions
              run: |
                  node release.cjs init
                  pnpm --filter ctool-adapter-chrome run platform-release
                  pnpm --filter ctool-adapter-edge run platform-release
                  pnpm --filter ctool-adapter-firefox run platform-release
                  pnpm --filter ctool-adapter-web run platform-release
                  ls -lh ./_release/
                  node release.cjs get

            - name: Get Release Files
              uses: edwardgeorge/file-outputs-action@main
              id: get_release_files
              with:
                  files: files=_release_files

            - name: Upload Assets
              uses: softprops/action-gh-release@v2
              with:
                  draft: true
                  files: |
                      ${{ steps.get_release_files.outputs.files }}

    # 构建 Tauri 桌面端（macOS + Windows）
    tauri-desktop:
        needs: create-release
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos-latest
                      target: aarch64-apple-darwin
                    - platform: macos-latest
                      target: x86_64-apple-darwin
                    - platform: windows-latest
                      target: x86_64-pc-windows-msvc

        runs-on: ${{ matrix.platform }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - uses: pnpm/action-setup@v4
              name: Install pnpm
              with:
                  version: 10
                  run_install: false

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ~/.local/share/pnpm/store
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: packages/ctool-adapter/tauri/src-tauri

            - name: Build core
              run: pnpm run build
              env:
                  NODE_OPTIONS: "--max_old_space_size=4096"

            - name: Build Tauri desktop
              shell: bash
              run: |
                  pnpm run initialize
                  node release.cjs init
                  pnpm --filter ctool-adapter-tauri run platform-release
                  ls ./_release/
                  node release.cjs get
              env:
                  TAURI_TARGET: ${{ matrix.target }}

            - name: Get Release Files
              uses: edwardgeorge/file-outputs-action@main
              id: get_release_files
              with:
                  files: files=_release_files

            - name: Upload Assets
              uses: softprops/action-gh-release@v2
              with:
                  draft: true
                  files: |
                      ${{ steps.get_release_files.outputs.files }}

    # 所有构建完成后，将 draft 发布为正式 release
    publish-release:
        needs: [browser-extensions, tauri-desktop]
        runs-on: ubuntu-latest
        steps:
            - name: Publish Release
              uses: actions/github-script@v7
              with:
                  script: |
                      // 查找当前 tag 对应的 draft release
                      const tag = context.ref.replace('refs/tags/', '');
                      const releases = await github.rest.repos.listReleases({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                      });
                      const draft = releases.data.find(r => r.tag_name === tag && r.draft);
                      if (!draft) {
                          core.setFailed(`未找到 tag ${tag} 对应的 draft release`);
                          return;
                      }
                      // 将 draft 改为正式发布
                      await github.rest.repos.updateRelease({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          release_id: draft.id,
                          draft: false,
                      });
                      core.info(`Release ${tag} 已发布: ${draft.html_url}`);
