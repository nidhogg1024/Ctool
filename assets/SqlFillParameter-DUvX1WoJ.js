import{u as $,i as F}from"./action-CSt0YebL.js";import{d as L,y as V,z,D as R,c as x,w,r as f,B as C,f as I,v as h,A as W,k as D,j as g}from"./tool-Ct-LHwIw.js";import"./modulepreload-polyfill-B5Qt9EMX.js";const M=L({__name:"SqlFillParameter",async setup(N){let p,v;const d=["String","Integer","Long","Timestamp"],i=$(([p,v]=V(()=>F({input:"",params:""})),p=await p,v(),p)),q=e=>{if(e){let a=e.split(",",-1),u=[],n=0,s=!1;return a.forEach(r=>{r.endsWith("null")?(u.push(r),n++):r.endsWith(")")?(s?(u[n]+=","+r,s=!1):u.push(r),n++):u[n]?u[n]+=","+r:(u.push(r),s=!0)}),u.map(r=>{let t=r.lastIndexOf("(");if(t<0)return{value:r,type:null};let l=r.substring(0,t);l=l.trim(),l=l.replaceAll("'","\\'");let m=r.lastIndexOf(")");m<0&&(m=r.length);let o=r.substring(t+1,m);return o=o.trim(),{value:l,type:o}})}else return[]},_=e=>{switch(e.type){case d[0]:return" '"+e.value+"'";case d[1]:case d[2]:return e.value;case d[3]:return"Timestamp '"+e.value+"'";default:return e.value}},y=e=>/#{(\w+)}/.test(e)?"mybatis":/(^|[^:]):(\w+)/.test(e)?"colon":"positional",P=e=>{const a=new Map;if(!e)return a;let u=e.split(",",-1),n=[],s=0,r=!1;return u.forEach(t=>{t.endsWith("null")&&t.includes("=")?(n.push(t),s++):t.endsWith(")")?(r?(n[s]+=","+t,r=!1):n.push(t),s++):n[s]?n[s]+=","+t:(n.push(t),r=!0)}),n.forEach(t=>{const l=t.indexOf("=");if(l<0)return;const m=t.substring(0,l).trim(),o=t.substring(l+1),c=o.lastIndexOf("(");if(c<0){a.set(m,{value:o.trim(),type:null});return}let S=o.substring(0,c).trim();S=S.replaceAll("'","\\'");const E=o.lastIndexOf(")"),T=o.substring(c+1,E<0?o.length:E).trim();a.set(m,{value:S,type:T})}),a},b=()=>{if(!i.current.input||!i.current.params)return"";const e=y(i.current.input);if(e==="colon"||e==="mybatis"){const r=P(i.current.params);let t=i.current.input;return e==="mybatis"?t=t.replace(/#\{(\w+)\}/g,(l,m)=>{const o=r.get(m);if(!o)throw new Error($t("sqlFillParameter_named_param_missing").replace("{name}",m));return _(o)}):t=t.replace(/(::?)(\w+)/g,(l,m,o)=>{if(m==="::")return l;const c=r.get(o);if(!c)throw new Error($t("sqlFillParameter_named_param_missing").replace("{name}",o));return _(c)}),t}let a=q(i.current.params),u=i.current.input,n="",s=0;for(let r=0;r<u.length;r++){let t=u.charAt(r);if(t==="?"){if(a.length<=s)throw new Error($t("sqlFillParameter_parameter_too_little"));n+=_(a[s]),s++}else n+=t}return n},A=e=>{const a={sql:"",params:""};let u="Preparing:",n=e.indexOf(u);n<0?n=0:n+=u.length;let s=e.indexOf(`
`,n);s<0&&(s=e.length),a.sql=e.substring(n,s);let r="Parameters:",t=e.indexOf(r);if(t>=0){let l=e.indexOf(`
`,t);l<0&&(l=e.length),a.params=e.substring(t+r.length,l)}return a},O=z(()=>{try{if(!i.current.input||!i.current.params)return"";let e=b();return i.save(),e}catch(e){return $error(e)}});return R(()=>({input:i.current.input,params:i.current.params}),({input:e})=>{if(e!==""&&e.includes("Preparing:")&&e.includes("Parameters:")){const a=A(e);a.sql!==""&&a.params!==""&&setTimeout(()=>{i.current.input=a.sql,i.current.params=a.params})}},{immediate:!0}),(e,a)=>{const u=f("Editor"),n=f("Textarea"),s=f("Align"),r=f("HeightResize"),t=C("row");return I(),x(r,{ignore:"",reduce:5},{default:w(({height:l})=>[h(s,{direction:"vertical"},{default:w(()=>[W((I(),D("div",null,[h(u,{modelValue:g(i).current.input,"onUpdate:modelValue":a[0]||(a[0]=m=>g(i).current.input=m),lang:"sql",height:l/2,placeholder:"Sql: SELECT * FROM T WHERE id=? AND name=?"},null,8,["modelValue","height"]),h(n,{modelValue:g(i).current.params,"onUpdate:modelValue":a[1]||(a[1]=m=>g(i).current.params=m),height:l/2,placeholder:`${e.$t("sqlFillParameter_parameter")}:
?模式: 1(Integer),zhangshan(String)
具名模式: id=1(Integer),name=zhangshan(String)`,copy:e.$t("sqlFillParameter_parameter")},null,8,["modelValue","height","placeholder","copy"])])),[[t,"1-1"]]),h(u,{"model-value":O.value,lang:"sql",height:l/2,placeholder:`${e.$t("main_ui_output")}: SELECT * FROM T WHERE id=1 AND name='zhangshan'`},null,8,["model-value","height","placeholder"])]),_:2},1024)]),_:1})}}});export{M as default};
